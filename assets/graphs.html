<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <title>Graphs</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="stylesheet" href="static/graphs.css">
</head>
<body style="text-align: center">
<header id="header">
    <nav class="links" style="--items: 5;">
        <a href="/"><img src="static/img/lamb.png" id="lamb" alt=""></a>
        <a href="/graphs">Графіки</a>
        <span class="line"></span>
    </nav>
</header>

<div id="title"></div>

<script>
    API_URL = "http://yevhenii.live:8087/api"

    pair = ["ETC", "USDT"]
    symbol = pair.join("")

    function infoUrlWithLimit(limit) {
        return  `${API_URL}/info?symbol=${symbol}&limit=${limit}`
    }

    document.getElementById("title").innerText = pair.join("/") + " conversion"

    google.charts.load('current', {'packages': ['corechart']});


    google.charts.setOnLoadCallback(() => {
        let data = new google.visualization.DataTable({
            cols: [
                {id: 'label', label: 'label', type: 'string'},
                {id: 'low', label: 'low', type: 'number'},
                {id: 'open', label: 'open', type: 'number'},
                {id: 'close', label: 'close', type: 'number'},
                {id: 'high', label: 'high', type: 'number'},
            ]
        });
        let options = {
            legend: 'none'
        };

        let chart1 = new google.visualization.CandlestickChart(document.getElementById('chart1_div'));
        let chart2 = new google.visualization.CandlestickChart(document.getElementById('chart2_div'));
        let chart3 = new google.visualization.CandlestickChart(document.getElementById('chart3_div'));
        let chart4 = new google.visualization.CandlestickChart(document.getElementById('chart4_div'));

        chart1.draw(data, options);
        chart2.draw(data, options);
        chart3.draw(data, options);
        chart4.draw(data, options);

        function addCandleJson(json) {
            addCandle(json["open_time"], json["low"], json["open"], json["close"], json["high"])
        }

        function addCandle(openTime, low, open, close, high) {
            data.addRow([openTime.toString(), parseFloat(low), parseFloat(open), parseFloat(close), parseFloat(high)])
            chart1.draw(data, options);
            chart2.draw(data, options);
            chart3.draw(data, options);
            chart4.draw(data, options);
        }

        function updateLastCandle(low, open, close, high) {
            data.setValue(data.getNumberOfRows() - 1, 1, low)
            data.setValue(data.getNumberOfRows() - 1, 2, open)
            data.setValue(data.getNumberOfRows() - 1, 3, close)
            data.setValue(data.getNumberOfRows() - 1, 4, high)
            chart1.draw(data, options);
            chart2.draw(data, options);
            chart3.draw(data, options);
            chart4.draw(data, options);
        }

        function processCandle(openTime, low, open, close, high) {
            if (openTime.toString() === data.getValue(data.getNumberOfRows() - 1)) {
                updateLastCandle(low, open, close, high)
            } else {
                data.removeRow(0)
                addCandle(openTime, low, open, close, high)
            }
        }

        function processCandleJson(json) {
            processCandle(json["open_time"], json["low"], json["open"], json["close"], json["high"])
        }


        fetch(infoUrlWithLimit(30)).then(value => {
            value.json().then(json => {
                for (let i = 0; i < json.length; i++) {
                    let candle = json[i];
                    addCandleJson(candle)
                }
            })
        })


        setInterval(function () {
            fetch(infoUrlWithLimit(1)).then(value => {
                value.json().then(json => {
                    let lastCandle = json[json.length - 1];
                    processCandleJson(lastCandle)
                })

            })
        }, 2000);
    });


</script>

<div class="wrapper">
    <div class="block">
        <h5>afd</h5>
        <div id="chart1_div" class="graph"></div>
    </div>
    <div class="block">
        <h5>afd</h5>
        <div id="chart2_div" class="graph"></div>
    </div>
    <div class="block">
        <h5>afd</h5>
        <div id="chart3_div" class="graph"></div>
    </div>
    <div class="block">
        <h5>afd</h5>
        <div id="chart4_div" class="graph"></div>
    </div>
</div>

</body>
</html>